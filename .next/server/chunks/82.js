"use strict";exports.id=82,exports.ids=[82],exports.modules={89082:(e,s,t)=>{t.r(s),t.d(s,{default:()=>C});var a=t(62983),n=t(80171),r=t(85981),o=t(83600),i=t(88033),d=t(63952),c=t(80388),p=t(98700),u=t(83897),l=t(96454),m=t(55503),g=t(79412),f=t(5247),h=t(31929),y=t(52679);let v=e=>({context:s})=>{let{count:t,include:a,exclude:n,responseType:r="message.received"}=e;return{count:t,domain:s.domain,from:s.connectTo,include:a?Array.isArray(a)?a:[a]:[],exclude:n?Array.isArray(n)?n:[n]:[],responseType:r,target:s.target,to:s.name}},b=e=>s=>{let{data:t}=s;return(!e.include.length||e.include.includes(t.type))&&(!e.exclude.length||!e.exclude.includes(t.type))&&t.domain===e.domain&&t.from===e.from&&t.to===e.to&&(!e.target||s.source===e.target)},T=e=>s=>({type:e,message:s}),k=(0,d.v)(()=>(0,c.R)(window,"message")),q=e=>(0,n.OX)(({input:s})=>k.pipe(e?(0,p.T)(e):(0,u.F)(),(0,l.p)(b(s)),(0,p.T)(T(s.responseType)),s.count?(0,u.F)((0,m.S)(s.count),(0,g.H)(e=>e),(0,f.s)(s.count)):(0,u.F)())),R="comlink/response",x="comlink/heartbeat",I="comlink/disconnect",w="comlink/handshake/syn",D="comlink/handshake/ack",S=e=>s=>s.pipe((0,f.s)(1),(0,p.T)(()=>{throw Error(e)})),A=()=>(0,r.mj)({types:{},actors:{listen:(0,n.OX)(({input:e})=>{let s=e.signal?(0,c.R)(e.signal,"abort").pipe(S(`Request ${e.requestId} aborted`)):h.w;return(0,c.R)(window,"message").pipe((0,l.p)(s=>s.data?.type===R&&s.data?.responseTo===e.requestId&&!!s.source&&e.sources.has(s.source)),(0,f.s)(e.sources.size),(0,y.Q)(s))})},actions:{"send message":({context:e},s)=>{let{sources:t,targetOrigin:a}=e,{message:n}=s;t.forEach(e=>{e.postMessage(n,{targetOrigin:a})})},"on success":(0,o.c)(({context:e})=>e.parentRef,({context:e,self:s})=>(e.response&&e.resolvable?.resolve(e.response),{type:"request.success",requestId:s.id,response:e.response,responseTo:e.responseTo})),"on fail":(0,o.c)(({context:e})=>e.parentRef,({context:e,self:s})=>(e.suppressWarnings||console.warn(`[@sanity/comlink] Received no response to message '${e.type}' on client '${e.from}' (ID: '${e.id}').`),e.resolvable?.reject(Error("No response received")),{type:"request.failed",requestId:s.id})),"on abort":(0,o.c)(({context:e})=>e.parentRef,({context:e,self:s})=>(e.resolvable?.reject(Error("Request aborted")),{type:"request.aborted",requestId:s.id}))},guards:{expectsResponse:({context:e})=>e.expectResponse},delays:{initialTimeout:0,responseTimeout:({context:e})=>e.responseTimeout??3e3}}).createMachine({context:({input:e})=>({channelId:e.channelId,data:e.data,domain:e.domain,expectResponse:e.expectResponse??!1,from:e.from,id:`msg-${(0,a.A)()}`,parentRef:e.parentRef,resolvable:e.resolvable,response:null,responseTimeout:e.responseTimeout,responseTo:e.responseTo,signal:e.signal,sources:e.sources instanceof Set?e.sources:new Set([e.sources]),suppressWarnings:e.suppressWarnings,targetOrigin:e.targetOrigin,to:e.to,type:e.type}),initial:"idle",on:{abort:".aborted"},states:{idle:{after:{initialTimeout:[{target:"sending"}]}},sending:{entry:{type:"send message",params:({context:e})=>{let{channelId:s,data:t,domain:a,from:n,id:r,responseTo:o,to:i,type:d}=e;return{message:{channelId:s,data:t,domain:a,from:n,id:r,to:i,type:d,responseTo:o}}}},always:[{guard:"expectsResponse",target:"awaiting"},"success"]},awaiting:{invoke:{id:"listen for response",src:"listen",input:({context:e})=>({requestId:e.id,sources:e.sources,signal:e.signal}),onError:"aborted"},after:{responseTimeout:"failed"},on:{message:{actions:(0,o.a)({response:({event:e})=>e.data.data,responseTo:({event:e})=>e.data.responseTo}),target:"success"}}},failed:{type:"final",entry:"on fail"},success:{type:"final",entry:"on success"},aborted:{type:"final",entry:"on abort"}},output:({context:e,self:s})=>({requestId:s.id,response:e.response,responseTo:e.responseTo})}),O=((0,n.SP)(({sendBack:e,input:s})=>{let t=()=>{e(s.event)};s.immediate&&t();let a=setInterval(t,s.interval);return()=>{clearInterval(a)}}),()=>(0,r.mj)({types:{},actors:{requestMachine:A(),listen:q()},actions:{"buffer handshake":(0,o.a)({handshakeBuffer:({event:e,context:s})=>((0,r.DT)(e,"message.received"),[...s.handshakeBuffer,e])}),"buffer message":(0,o.b)(({enqueue:e})=>{e.assign({buffer:({event:e,context:s})=>((0,r.DT)(e,"post"),[...s.buffer,{data:e.data,resolvable:e.resolvable,options:e.options}])}),e.emit(({event:e})=>((0,r.DT)(e,"post"),{type:"buffer.added",message:e.data}))}),"create request":(0,o.a)({requests:({context:e,event:s,self:t,spawn:n})=>{(0,r.DT)(s,"request");let o=(Array.isArray(s.data)?s.data:[s.data]).map(s=>n("requestMachine",{id:`req-${(0,a.A)()}`,input:{channelId:e.channelId,data:s.data,domain:e.domain,expectResponse:s.expectResponse,from:e.name,parentRef:t,resolvable:s.resolvable,responseTimeout:s.options?.responseTimeout,responseTo:s.responseTo,signal:s.options?.signal,sources:e.target,suppressWarnings:s.options?.suppressWarnings,targetOrigin:e.targetOrigin,to:e.connectTo,type:s.type}}));return[...e.requests,...o]}}),"emit heartbeat":(0,o.e)(()=>({type:"heartbeat"})),"emit received message":(0,o.b)(({enqueue:e})=>{e.emit(({event:e})=>((0,r.DT)(e,"message.received"),{type:"message",message:e.message.data}))}),"emit status":(0,o.e)((e,s)=>({type:"status",status:s.status})),"post message":(0,i.O)(({event:e})=>((0,r.DT)(e,"post"),{type:"request",data:{data:e.data.data,expectResponse:!!e.resolvable,type:e.data.type,resolvable:e.resolvable,options:e.options}})),"process pending handshakes":(0,o.b)(({context:e,enqueue:s})=>{e.handshakeBuffer.forEach(e=>s.raise(e)),s.assign({handshakeBuffer:[]})}),"remove request":(0,o.b)(({context:e,enqueue:s,event:t})=>{(0,r.DT)(t,["request.success","request.failed","request.aborted"]),(0,i.R)(t.requestId),s.assign({requests:e.requests.filter(({id:e})=>e!==t.requestId)})}),"send response":(0,i.O)(({event:e})=>((0,r.DT)(e,["message.received","heartbeat.received"]),{type:"request",data:{type:R,responseTo:e.message.data.id,data:void 0}})),"send handshake syn ack":(0,i.O)({type:"request",data:{type:"comlink/handshake/syn-ack"}}),"send pending messages":(0,o.b)(({enqueue:e})=>{e.raise(({context:e})=>({type:"request",data:e.buffer.map(({data:e,resolvable:s,options:t})=>({data:e.data,type:e.type,expectResponse:!!s,resolvable:s,options:t}))})),e.emit(({context:e})=>({type:"buffer.flushed",messages:e.buffer.map(({data:e})=>e)})),e.assign({buffer:[]})}),"set connection config":(0,o.a)({channelId:({event:e})=>((0,r.DT)(e,"handshake.syn"),e.message.data.channelId),target:({event:e})=>((0,r.DT)(e,"handshake.syn"),e.message.source||void 0),targetOrigin:({event:e})=>((0,r.DT)(e,"handshake.syn"),e.message.origin)})},guards:{hasSource:({context:e})=>null!==e.target}}).createMachine({id:"node",context:({input:e})=>({buffer:[],channelId:null,connectTo:e.connectTo,domain:e.domain??"sanity/comlink",handshakeBuffer:[],name:e.name,requests:[],target:void 0,targetOrigin:null}),invoke:{id:"listen for handshake syn",src:"listen",input:v({include:w,responseType:"handshake.syn"})},on:{"request.success":{actions:"remove request"},"request.failed":{actions:"remove request"},"request.aborted":{actions:"remove request"},"handshake.syn":{actions:"set connection config",target:".handshaking"}},initial:"idle",states:{idle:{entry:[{type:"emit status",params:{status:"idle"}}],on:{post:{actions:"buffer message"}}},handshaking:{guard:"hasSource",entry:["send handshake syn ack",{type:"emit status",params:{status:"handshaking"}}],invoke:[{id:"listen for handshake ack",src:"listen",input:v({include:D,count:1,responseType:"handshake.complete"}),onDone:"connected"},{id:"listen for disconnect",src:"listen",input:v({include:I,count:1,responseType:"disconnect"})},{id:"listen for messages",src:"listen",input:v({exclude:[I,w,D,x,R]})}],on:{request:{actions:"create request"},post:{actions:"buffer message"},"message.received":{actions:"buffer handshake"},disconnect:{target:"idle"}}},connected:{entry:["process pending handshakes","send pending messages",{type:"emit status",params:{status:"connected"}}],invoke:[{id:"listen for messages",src:"listen",input:v({exclude:[I,w,D,x,R]})},{id:"listen for heartbeat",src:"listen",input:v({include:x,responseType:"heartbeat.received"})},{id:"listen for disconnect",src:"listen",input:v({include:I,count:1,responseType:"disconnect"})}],on:{request:{actions:"create request"},post:{actions:"post message"},disconnect:{target:"idle"},"message.received":{actions:["send response","emit received message"]},"heartbeat.received":{actions:["send response","emit heartbeat"]}}}}})),E=(e,s=O())=>{let t;let a=(0,i.A)(s,{input:e}),n=new Map,r=new Map;a.on("message",({message:e})=>{let s=n.get(e.type);if(s){s.forEach(s=>s(e.data));return}let t=r.get(e.type);t?t.add(e):r.set(e.type,new Set([e]))});let o=()=>{a.stop()};return{actor:a,fetch:(e,s,t)=>{let{responseTimeout:n=1e4,signal:r,suppressWarnings:o}=t||{},i=Promise.withResolvers();return a.send({type:"post",data:{type:e,data:s},resolvable:i,options:{responseTimeout:n,signal:r,suppressWarnings:o}}),i.promise},machine:s,on:(e,s,t)=>{let a=n.get(e)||new Set;n.has(e)||n.set(e,a),a.add(s);let o=r.get(e);if(o){let a=t?.replay??1;Array.from(o).slice(-a).forEach(({data:e})=>s(e)),r.delete(e)}return()=>{a.delete(s)}},onStatus:(e,s)=>{let{unsubscribe:n}=a.on("status",a=>{t=a.status,s&&a.status!==s||e(a.status)});return t&&e(t),n},post:(e,s)=>{a.send({type:"post",data:{type:e,data:s}})},start:()=>(a.start(),o),stop:o}};var M=t(26248);let $=(0,M.createServerReference)("7f8215dfa928ea9ec40bd4d2e651c726d59f0ea5a6",M.callServer,void 0,M.findSourceMapURL,"setPerspectiveCookie");var j=t(88604),B=t(79334),F=t(58009),W=t(86110),P=t(88432);function C(e){let{draftModeEnabled:s,draftModePerspective:t}=e,a=(0,B.useRouter)(),n=(0,W.J)((e,n)=>{s&&e!==t&&$(e).then(()=>{n.aborted||a.refresh()}).catch(e=>console.error("Failed to set the preview perspective cookie",e))});return(0,F.useEffect)(()=>{let e;let s=E({name:"loaders",connectTo:"presentation"},O().provide({actors:(0,j.jF)()}));s.on("loader/perspective",s=>{e?.abort(),e=new AbortController,n(s.perspective,e.signal)});let t=s.start();return(0,P.El)(s),()=>{t()}},[n]),null}C.displayName="PresentationComlink"}};